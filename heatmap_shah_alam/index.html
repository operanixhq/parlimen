<!DOCTYPE html>
<html>
<head>
  <title>Heatmap Aduan Shah Alam</title>
  <meta charset="utf-8"/>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <!-- Leaflet Heat -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

  <style>
    body { margin:0; }
    #map { width:100%; height:100vh; }
  </style>
</head>
<body>

<div id="map"></div>

<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTXBgy7se3-U4mSHdnbZ6YiRYToQEVFtEKuZ_z_RRCby7nYGd-HViMSNexPxFHP2pENCUjkX3ofqqlE/pub?output=csv"

const GEOJSON_URL = "https://raw.githubusercontent.com/operanixhq/parlimen/main/P108_shah_alam.geojson"

const map = L.map('map').setView([3.0738, 101.5183], 12)

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19
}).addTo(map)

async function loadCSVPoints() {
  const res = await fetch(CSV_URL)
  const text = await res.text()

  const rows = text.trim().split("\n").slice(1)

  const points = rows.map(r => {
    const cols = r.split(",")
    // lat = column G (index 6), lng = column H (index 7)
    const lat = parseFloat(cols[6])
    const lng = parseFloat(cols[7])
    if (!isNaN(lat) && !isNaN(lng)) return [lat, lng]
  }).filter(Boolean)

  console.log("POINTS COUNT:", points.length)

  return points
}

async function loadBoundary() {
  const res = await fetch(GEOJSON_URL)
  const geojson = await res.json()

  const boundary = L.geoJSON(geojson, {
    style: {
      color: "blue",
      weight: 3,
      fillOpacity: 0
    }
  }).addTo(map)

  map.fitBounds(boundary.getBounds())
}

async function init() {
  await loadBoundary()

  const points = await loadCSVPoints()

  // Optional debug: show red dots
  // points.forEach(p => L.circleMarker(p,{radius:3,color:"red"}).addTo(map))

  const heat = L.heatLayer(points, {
    radius: 45,
    blur: 30,
    maxZoom: 17,
    minOpacity: 0.6
  }).addTo(map)
}

init()
</script>

</body>
</html>

