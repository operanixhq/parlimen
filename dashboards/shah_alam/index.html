<!DOCTYPE html>
<html>
<head>
  <title>Operanix | Peta Aduan Shah Alam</title>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

  <style>
    body { margin:0; font-family: Arial, sans-serif; }
    #map { width:100%; height:100vh; }

    #filters {
      position:absolute;
      top:10px;
      right:10px;
      background:white;
      padding:12px;
      border-radius:8px;
      box-shadow:0 2px 8px rgba(0,0,0,0.25);
      z-index:999;
      font-size:13px;
      line-height:1.6;
      min-width:220px;
    }

    #filters input, #filters select {
      width:100%;
      margin-top:4px;
      margin-bottom:6px;
      padding:4px;
      font-size:13px;
    }

    .pin {
      width:18px;
      height:18px;
      background:#0080ff;
      border-radius:50%;
      position:relative;
      box-shadow:0 0 0 rgba(0,128,255,0.6);
      animation:pulse 2s infinite;
      cursor:pointer;
    }

    @keyframes pulse {
      0%   {box-shadow:0 0 0 0 rgba(0,128,255,0.6);}
      70%  {box-shadow:0 0 0 15px rgba(0,128,255,0);}
      100%{box-shadow:0 0 0 0 rgba(0,128,255,0);}
    }

    .pin:hover {
      background:#ff6600;
      transform:scale(1.3);
    }
  </style>
</head>
<body>

<div id="filters">

  <label>
    <input type="checkbox" id="showAll" checked>
    Lihat semua kes
  </label>

  <hr>

  Tarikh mula:
  <input type="date" id="startDate">

  Tarikh akhir:
  <input type="date" id="endDate">

  Kategori:
  <select id="categoryFilter">
    <option value="">Semua kategori</option>
  </select>

  <button onclick="applyFilter()">Tapis</button>
  <button onclick="resetFilter()">Reset</button>

</div>

<div id="map"></div>

<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTXBgy7se3-U4mSHdnbZ6YiRYToQEVFtEKuZ_z_RRCby7nYGd-HViMSNexPxFHP2pENCUjkX3ofqqlE/pub?output=csv"
const GEOJSON_URL = "P108_shah_alam.geojson"

const map = L.map('map').setView([3.0738,101.5183],12)

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:18}).addTo(map)

map.createPane("heatPane")
map.getPane("heatPane").style.zIndex = 200
map.createPane("pinPane")
map.getPane("pinPane").style.zIndex = 400

let heatLayer
let pinLayerGroup = L.layerGroup().addTo(map)
let allCases = []


// CSV parser (handles comma inside text)
function parseCSV(text){
  const rows=[]
  let row=[],col="",quote=false
  for(let c of text){
    if(c=='"') quote=!quote
    else if(c=="," && !quote){ row.push(col); col="" }
    else if(c=="\n" && !quote){ row.push(col); rows.push(row); row=[]; col="" }
    else col+=c
  }
  row.push(col); rows.push(row)
  return rows
}


async function loadBoundary(){
  const res = await fetch(GEOJSON_URL)
  const geojson = await res.json()
  const layer = L.geoJSON(geojson,{
    style:{color:"#0033aa",weight:3,fillOpacity:0}
  }).addTo(map)
  map.fitBounds(layer.getBounds())
}


async function loadCases(){
  const res = await fetch(CSV_URL)
  const text = await res.text()
  const table = parseCSV(text.trim())
  table.shift()

  let cases=[]

  table.forEach(cols=>{
    const case_id = cols[0]
    const date = cols[1]           // format yyyy-mm-dd
    const category = cols[3]
    const summary = cols[4]
    const lat = parseFloat(cols[6])
    const lng = parseFloat(cols[7])

    if(!isNaN(lat) && !isNaN(lng)){
      cases.push({case_id,date,category,summary,lat,lng})
    }
  })

  return cases
}


function renderMap(cases){
  if(heatLayer) map.removeLayer(heatLayer)
  pinLayerGroup.clearLayers()

  const heatPoints = cases.map(c=>[c.lat,c.lng,1])
  heatLayer = L.heatLayer(heatPoints,{
    radius:45, blur:30, minOpacity:0.5, pane:"heatPane"
  }).addTo(map)

  cases.forEach(c=>{
    const icon = L.divIcon({
      className:"",
      html:'<div class="pin"></div>',
      iconSize:[18,18],
      iconAnchor:[9,9]
    })

    const marker = L.marker([c.lat,c.lng],{icon,pane:"pinPane"})

    const popup = `
      <div style="font-size:14px;line-height:1.4">
        <strong>${c.category}</strong><br>
        ${c.summary}<br><br>
        <a href="details.html?case_id=${encodeURIComponent(c.case_id)}"
           style="color:#0066ff;font-weight:bold;text-decoration:none">
           Lihat detail →
        </a>
      </div>
    `
    marker.bindPopup(popup)
    pinLayerGroup.addLayer(marker)
  })
}


function updateCategoryDropdown(filteredCases){
  const sel = document.getElementById("categoryFilter")
  sel.innerHTML = '<option value="">Semua kategori</option>'

  const cats = [...new Set(filteredCases.map(c=>c.category))].sort()
  cats.forEach(cat=>{
    const opt = document.createElement("option")
    opt.value = cat
    opt.textContent = cat
    sel.appendChild(opt)
  })
}


function applyFilter(){

  const showAll = document.getElementById("showAll").checked
  const startDate = document.getElementById("startDate").value
  const endDate = document.getElementById("endDate").value
  const cat = document.getElementById("categoryFilter").value

  // If show all → ignore everything
  if(showAll){
    renderMap(allCases)
    updateCategoryDropdown(allCases)
    return
  }

  let filtered = allCases

  // Date filter (single or range)
  if(startDate && !endDate){
    filtered = filtered.filter(c => c.date.startsWith(startDate))
  }

  if(startDate && endDate){
    filtered = filtered.filter(c => 
      c.date >= startDate && c.date <= endDate
    )
  }

  // Update category dropdown based on date-filtered result
  updateCategoryDropdown(filtered)

  // Apply category filter if selected
  if(cat){
    filtered = filtered.filter(c => c.category === cat)
  }

  renderMap(filtered)
}


function resetFilter(){
  document.getElementById("showAll").checked = true
  document.getElementById("startDate").value = ""
  document.getElementById("endDate").value = ""
  updateCategoryDropdown(allCases)
  renderMap(allCases)
}


document.getElementById("showAll").addEventListener("change",()=>{
  if(document.getElementById("showAll").checked){
    resetFilter()
  }
})


async function init(){
  await loadBoundary()
  allCases = await loadCases()
  updateCategoryDropdown(allCases)
  renderMap(allCases)
}

init()
map.on('click',()=> map.closePopup())
</script>
</body>
</html>
