<!DOCTYPE html>
<html>
<head>
  <title>Operanix | Peta Aduan Shah Alam</title>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Leaflet Heat -->
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

  <style>
    body { margin:0; font-family: Arial, sans-serif; }
    #map { width:100%; height:100vh; }

    /* Animated pulsing pin */
    .pin {
      width:18px;
      height:18px;
      background:#0080ff;
      border-radius:50%;
      position: relative;
      box-shadow: 0 0 0 rgba(0,128,255,0.6);
      animation: pulse 2s infinite;
      cursor:pointer;
    }

    @keyframes pulse {
      0%   { box-shadow: 0 0 0 0 rgba(0,128,255,0.6); }
      70%  { box-shadow: 0 0 0 15px rgba(0,128,255,0); }
      100%{ box-shadow: 0 0 0 0 rgba(0,128,255,0); }
    }

    .pin:hover {
      background:#ff6600;
      transform: scale(1.3);
    }
  </style>
</head>
<body>

<div id="map"></div>

<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTXBgy7se3-U4mSHdnbZ6YiRYToQEVFtEKuZ_z_RRCby7nYGd-HViMSNexPxFHP2pENCUjkX3ofqqlE/pub?output=csv"
const GEOJSON_URL = "P108_shah_alam.geojson"

const map = L.map('map').setView([3.0738, 101.5183], 12)

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  maxZoom:18
}).addTo(map)

// --- Load boundary ---
async function loadBoundary(){
  const res = await fetch(GEOJSON_URL)
  const geojson = await res.json()

  const layer = L.geoJSON(geojson,{
    style:{
      color:"#0033aa",
      weight:3,
      fillOpacity:0
    }
  }).addTo(map)

  map.fitBounds(layer.getBounds())
}


// --- CSV parser that handles commas inside text ---
function parseCSV(text){
  const rows = []
  let row = []
  let col = ''
  let insideQuotes = false

  for (let i=0;i<text.length;i++){
    const c = text[i]

    if (c === '"' ) {
      insideQuotes = !insideQuotes
    } 
    else if (c === ',' && !insideQuotes){
      row.push(col)
      col = ''
    }
    else if (c === '\n' && !insideQuotes){
      row.push(col)
      rows.push(row)
      row=[]
      col=''
    }
    else {
      col += c
    }
  }
  row.push(col)
  rows.push(row)

  return rows
}


// --- Load cases from sheet ---
async function loadCases(){
  const res = await fetch(CSV_URL)
  const text = await res.text()

  const table = parseCSV(text.trim())
  table.shift() // remove header

  let heatPoints = []
  let casePoints = []

  table.forEach(cols => {

    // ===== Column mapping =====
    const case_id   = cols[0]   // col 0
    const category = cols[3]   // col 3
    const summary  = cols[4]   // col 4
    const lat      = parseFloat(cols[6]) // col G
    const lng      = parseFloat(cols[7]) // col H
    // ==========================

    if (!isNaN(lat) && !isNaN(lng)) {
      heatPoints.push([lat,lng,1])
      casePoints.push({
        case_id,
        category,
        summary,
        lat,
        lng
      })
    }
  })

  return {heatPoints, casePoints}
}


// --- Heatmap ---
function addHeat(points){
  L.heatLayer(points,{
    radius:45,
    blur:30,
    minOpacity:0.5
  }).addTo(map)
}


// --- Pins + popup ---
function addPins(casePoints){

  casePoints.forEach(c => {

    const icon = L.divIcon({
      className:"",
      html:'<div class="pin"></div>',
      iconSize:[18,18],
      iconAnchor:[9,9]
    })

    const marker = L.marker([c.lat,c.lng],{icon}).addTo(map)

    const popupHtml = `
      <div style="font-size:14px;line-height:1.4;max-width:220px">
        <strong>${c.category}</strong><br>
        ${c.summary}<br><br>
        <a href="details.html?case_id=${encodeURIComponent(c.case_id)}"
           style="color:#0066ff;text-decoration:none;font-weight:bold">
           Lihat detail â†’
        </a>
      </div>
    `

    marker.bindPopup(popupHtml)
  })
}


// --- Init ---
async function init(){
  await loadBoundary()
  const data = await loadCases()
  addHeat(data.heatPoints)
  addPins(data.casePoints)
}

init()

// close popup when click map
map.on('click',()=> map.closePopup())

</script>
</body>
</html>
