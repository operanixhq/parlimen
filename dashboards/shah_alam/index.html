<!DOCTYPE html>
<html>
<head>
  <title>Operanix | Peta Aduan Shah Alam</title>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Leaflet Heat -->
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

  <style>
    body { margin:0; font-family: Arial, sans-serif; }
    #map { width:100%; height:100vh; }

    #filters {
      position:absolute;
      top:10px;
      right:10px;
      background:white;
      padding:10px;
      border-radius:8px;
      box-shadow:0 2px 6px rgba(0,0,0,0.2);
      z-index:1000;
      font-size:13px;
    }
    #filters label { display:block; margin-bottom:6px; }
  </style>
</head>
<body>

<div id="filters">
  <label>Dari:
    <input type="date" id="dateFrom">
  </label>

  <label>Hingga:
    <input type="date" id="dateTo">
  </label>

  <label>Kategori:
    <select id="categoryFilter">
      <option value="">Semua</option>
      <option value="Infrastruktur">Infrastruktur</option>
      <option value="Keselamatan">Keselamatan</option>
      <option value="Kebajikan">Kebajikan</option>
      <option value="Lain-lain">Lain-lain</option>
    </select>
  </label>

  <div id="countBox"></div>
</div>

<div id="map"></div>

<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTXBgy7se3-U4mSHdnbZ6YiRYToQEVFtEKuZ_z_RRCby7nYGd-HViMSNexPxFHP2pENCUjkX3ofqqlE/pub?output=csv"
const GEOJSON_URL = "P108_shah_alam.geojson"

// Init map
const map = L.map('map').setView([3.0738, 101.5183], 12)

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 18
}).addTo(map)

// Global storage
let allCases = []
let heatLayer = null
let pinLayer = L.layerGroup().addTo(map)

// Load boundary
async function loadBoundary() {
  const res = await fetch(GEOJSON_URL)
  const geojson = await res.json()

  const boundary = L.geoJSON(geojson, {
    style: { color:"#0033aa", weight:3, fillOpacity:0 }
  }).addTo(map)

  map.fitBounds(boundary.getBounds())
}

// Load CSV
async function loadCases() {
  const res = await fetch(CSV_URL)
  const text = await res.text()
  const rows = text.trim().split("\n").slice(1)

  allCases = rows.map(r => {
    const c = r.split(",")

    return {
      case_id: c[0],
      created_at: c[1],      
      category: c[2],
      summary: c[4],
      lat: parseFloat(c[6]),
      lng: parseFloat(c[7])
    }
  }).filter(c => !isNaN(c.lat) && !isNaN(c.lng))
}

// Apply filters
function applyFilters() {
  const from = document.getElementById("dateFrom").value
  const to = document.getElementById("dateTo").value
  const category = document.getElementById("categoryFilter").value

  let filtered = allCases.filter(c => {
    let ok = true
    if (from && c.created_at < from) ok = false
    if (to && c.created_at > to) ok = false
    if (category && c.category !== category) ok = false
    return ok
  })

  redrawMap(filtered)

  document.getElementById("countBox").innerText =
    filtered.length + " kes dipaparkan"
}

// Redraw map layers
function redrawMap(cases) {
  if (heatLayer) map.removeLayer(heatLayer)
  pinLayer.clearLayers()

  const heatPoints = cases.map(c => [c.lat, c.lng, 1])

  heatLayer = L.heatLayer(heatPoints, {
    radius:40,
    blur:30,
    minOpacity:0.5
  }).addTo(map)

  cases.forEach(c => {
    const marker = L.marker([c.lat, c.lng]).addTo(pinLayer)

    const popupHtml = `
      <div style="font-size:13px;line-height:1.4">
        <strong>${c.category}</strong><br>
        ${c.summary}<br><br>
        <a href="details.html?case_id=${encodeURIComponent(c.case_id)}" target="_blank">
          Lihat detail â†’
        </a>
      </div>
    `
    marker.bindPopup(popupHtml)
  })
}

// Hook filter events
document.getElementById("dateFrom").addEventListener("change", applyFilters)
document.getElementById("dateTo").addEventListener("change", applyFilters)
document.getElementById("categoryFilter").addEventListener("change", applyFilters)

// Init
async function init() {
  await loadBoundary()
  await loadCases()

  // default last 7 days
  const today = new Date().toISOString().slice(0,10)
  const weekAgo = new Date(Date.now()-6*24*60*60*1000).toISOString().slice(0,10)

  document.getElementById("dateFrom").value = weekAgo
  document.getElementById("dateTo").value = today

  applyFilters()
}

init()
</script>

</body>
</html>
