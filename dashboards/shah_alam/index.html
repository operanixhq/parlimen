<!DOCTYPE html>
<html>
<head>
  <title>Operanix | Peta Aduan Shah Alam</title>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Leaflet Heat -->
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

  <style>
    body { margin:0; font-family: Arial, sans-serif; }
    #map { width:100%; height:100vh; }

    /* Modern pulsing pin */
    .pin {
      width: 16px;
      height: 16px;
      background: #0066ff;
      border-radius: 50%;
      position: relative;
      box-shadow: 0 0 0 rgba(0,102,255,0.6);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(0,102,255,0.6); }
      70% { box-shadow: 0 0 0 12px rgba(0,102,255,0); }
      100% { box-shadow: 0 0 0 0 rgba(0,102,255,0); }
    }

    .pin:hover {
      background:#ff6600;
      transform: scale(1.3);
    }
  </style>
</head>
<body>

<div id="map"></div>

<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTXBgy7se3-U4mSHdnbZ6YiRYToQEVFtEKuZ_z_RRCby7nYGd-HViMSNexPxFHP2pENCUjkX3ofqqlE/pub?output=csv"
const GEOJSON_URL = "P108_shah_alam.geojson"

// Init map
const map = L.map('map').setView([3.0738, 101.5183], 12)

// Base map
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 18
}).addTo(map)

// Load boundary
async function loadBoundary() {
  const res = await fetch(GEOJSON_URL)
  const geojson = await res.json()

  const boundary = L.geoJSON(geojson, {
    style: {
      color: "#0033aa",
      weight: 3,
      fillOpacity: 0
    }
  }).addTo(map)

  map.fitBounds(boundary.getBounds())
}

// Load CSV & extract points
async function loadCases() {
  const res = await fetch(CSV_URL)
  const text = await res.text()

  const rows = text.trim().split("\n").slice(1)

  let heatPoints = []
  let casePoints = []

  rows.forEach(r => {
    const cols = r.split(",")

    const case_id = cols[0]
    const category = cols[3]
    const summary = cols[4]
    const lat = parseFloat(cols[6])
    const lng = parseFloat(cols[7])

    if (!isNaN(lat) && !isNaN(lng)) {
      heatPoints.push([lat, lng, 1])
      casePoints.push({category, summary, lat, lng})
    }
  })

  return {heatPoints, casePoints}
}

// Add heatmap
function addHeat(points) {
  L.heatLayer(points, {
    radius: 40,
    blur: 30,
    minOpacity: 0.5
  }).addTo(map)
}

// Add clickable pins with popup
function addPins(casePoints) {
  casePoints.forEach(c => {

    const icon = L.divIcon({
      className: '',
      html: '<div class="pin"></div>',
      iconSize: [16,16],
      iconAnchor: [8,8]
    })

    const marker = L.marker([c.lat, c.lng], {icon}).addTo(map)

    const popupHtml = `
      <div style="font-size:14px;line-height:1.4">
        <strong>Kategori:</strong> ${c.category}<br>
        <strong>Ringkasan Aduan:</strong> ${c.summary}<br><br>
        <a href="details.html?case_id=${encodeURIComponent(c.case_id)}"
           target="_blank"
           style="color:#0066ff;text-decoration:none;font-weight:bold">
           Lihat detail â†’
        </a>
      </div>
    `

    marker.bindPopup(popupHtml)
  })
}

// Init everything
async function init() {
  await loadBoundary()
  const data = await loadCases()
  addHeat(data.heatPoints)
  addPins(data.casePoints)
}

init()

// Close popup when clicking map
map.on('click', () => map.closePopup())

</script>
</body>
</html>
