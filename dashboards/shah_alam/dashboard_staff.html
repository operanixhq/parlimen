<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Operanix | Dashboard Staf</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{
  font-family: Arial, sans-serif;
  margin:0;
  padding:16px;
  background:#f4f6f8;
}
h2{ margin:0 0 12px 0; }
.card{
  background:#fff;
  padding:14px;
  border-radius:10px;
  box-shadow:0 2px 6px rgba(0,0,0,0.1);
  margin-bottom:14px;
}
input, select, button, textarea{
  padding:6px;
  font-size:14px;
  margin-right:6px;
}
button{
  background:#0066ff;
  color:#fff;
  border:none;
  border-radius:6px;
  cursor:pointer;
}
button:hover{ background:#004ecc; }
button.secondary{ background:#555; }
table{
  width:100%;
  border-collapse:collapse;
  font-size:13px;
}
th, td{
  padding:8px;
  border-bottom:1px solid #ddd;
  text-align:left;
}
th{ background:#f0f0f0; }
.status-baru{color:#0066ff;font-weight:bold;}
.status-dalamproses{color:#ff9900;font-weight:bold;}
.status-selesai{color:#00aa55;font-weight:bold;}
.status-escalate{color:#e60000;font-weight:bold;}
.small{ font-size:12px;color:#555; }
.badge{
  display:inline-block;
  padding:2px 6px;
  border-radius:6px;
  font-size:11px;
  font-weight:bold;
  margin-left:6px;
}
.badge-today{ background:#e6f0ff; color:#0052cc; }
.badge-yesterday{ background:#f0f0f0; color:#666; }
.sla-ok{ color:#555; }
.sla-warn{ color:#ff9900; font-weight:bold; }
.sla-breach{ color:#e60000; font-weight:bold; }

/* MODAL */
.modal{
  display:none;
  position:fixed;
  top:0;left:0;right:0;bottom:0;
  background:rgba(0,0,0,0.5);
  z-index:9999;
}
.modal-content{
  background:#fff;
  max-width:520px;
  margin:8% auto;
  padding:16px;
  border-radius:10px;
}
.modal h3{ margin-top:0; }
.log-item{
  border-bottom:1px solid #eee;
  padding:8px 0;
  font-size:13px;
}
.log-item:last-child{ border-bottom:none; }
</style>
</head>

<body>

<script>
/* ===== AUTH CHECK ===== */
if(localStorage.getItem("operanix_auth") !== "ok"){
  location.replace("login.html");
}

/* ===== READ CASE_ID FROM URL ===== */
const urlParams = new URLSearchParams(window.location.search);
const PRESELECT_CASE_ID = urlParams.get("case_id");

/* ===== MALAYSIA DATE TIME ===== */
function formatMalaysiaDateTime(ts){
  if(!ts) return "-";
  const d = new Date(ts);
  const opt = {
    timeZone: "Asia/Kuala_Lumpur",
    day: "2-digit",
    month: "2-digit",
    year: "numeric",
    hour: "2-digit",
    minute: "2-digit",
    hour12: true
  };
  const parts = new Intl.DateTimeFormat("en-GB", opt).formatToParts(d);
  const get = t => parts.find(p => p.type === t)?.value || "";
  return `${get("day")}-${get("month")}-${get("year")} • ${get("hour")}:${get("minute")} ${get("dayPeriod").toUpperCase()}`;
}

/* ===== BADGE HARI ===== */
function dayBadge(ts){
  const now = new Date();
  const myNow = new Date(now.toLocaleString("en-US",{timeZone:"Asia/Kuala_Lumpur"}));
  const d = new Date(ts);
  const myDate = new Date(d.toLocaleString("en-US",{timeZone:"Asia/Kuala_Lumpur"}));
  const diffDays = Math.floor((myNow - myDate) / (1000*60*60*24));
  if(diffDays === 0) return '<span class="badge badge-today">Hari Ini</span>';
  if(diffDays === 1) return '<span class="badge badge-yesterday">Semalam</span>';
  return "";
}

/* ===== SLA TIMER (HARI + JAM) ===== */
function slaInfo(ts, status){
  if(status === "selesai") return "-";
  const now = new Date();
  const myNow = new Date(now.toLocaleString("en-US",{timeZone:"Asia/Kuala_Lumpur"}));
  const d = new Date(ts);
  const myDate = new Date(d.toLocaleString("en-US",{timeZone:"Asia/Kuala_Lumpur"}));

  const totalHours = Math.floor((myNow - myDate) / (1000*60*60));
  const days = Math.floor(totalHours / 24);
  const hours = totalHours % 24;

  const label = `${days > 0 ? days+"h " : ""}${hours}j`;

  if(totalHours >= 48) return `<span class="sla-breach">${label}</span>`;
  if(totalHours >= 24) return `<span class="sla-warn">${label}</span>`;
  return `<span class="sla-ok">${label}</span>`;
}
</script>

<h2>Dashboard Operasi Staf</h2>

<div class="card">
  <input type="date" id="filterDate">
  <select id="filterKategori">
    <option value="">Semua Kategori</option>
  </select>
  <select id="filterStatus">
    <option value="">Semua Status</option>
    <option value="baru">Baru</option>
    <option value="dalam proses">Dalam Proses</option>
    <option value="selesai">Selesai</option>
    <option value="escalate">Escalate</option>
  </select>
  <input type="text" id="searchCase" placeholder="Cari Case ID">
  <button onclick="renderTable()">Tapis</button>
</div>

<div class="card">
<table>
  <thead>
    <tr>
      <th>Case ID</th>
      <th>Tarikh</th>
      <th>Kategori</th>
      <th>Status</th>
      <th>SLA</th>
      <th>Tindakan</th>
    </tr>
  </thead>
  <tbody id="caseTable"></tbody>
</table>
</div>

<!-- UPDATE MODAL -->
<div class="modal" id="updateModal">
  <div class="modal-content">
    <h3>Kemaskini Status</h3>
    <b id="updateCaseId"></b><br><br>
    <select id="updateStatus">
      <option value="">-- Pilih Status --</option>
      <option value="dalam proses">Dalam Proses</option>
      <option value="selesai">Selesai</option>
      <option value="escalate">Escalate</option>
    </select><br><br>
    <textarea id="updateNote" rows="3" style="width:100%" placeholder="Catatan (optional)"></textarea><br><br>
    <button onclick="confirmUpdate()">Simpan</button>
    <button class="secondary" onclick="closeUpdate()">Batal</button>
  </div>
</div>

<!-- HISTORY MODAL -->
<div class="modal" id="historyModal">
  <div class="modal-content">
    <h3>Sejarah Kes</h3>
    <div id="historyContent">Loading...</div><br>
    <button class="secondary" onclick="closeHistory()">Tutup</button>
  </div>
</div>

<script>
const API_GET_URL = "https://script.google.com/macros/s/AKfycbzNoivsmUm18JtTC4S_f_arsl9zaH1IpwmxwTbxpDS8rb7txwvMQ_kR-nBFfpW8b57axw/exec";
const API_POST_URL = API_GET_URL;

let allCases = [];
let selectedCaseId = null;

/* LOAD DATA */
fetch(API_GET_URL)
.then(r=>r.json())
.then(data=>{
  allCases = data;
  populateKategori();
  if(PRESELECT_CASE_ID) searchCase.value = PRESELECT_CASE_ID;
  renderTable();
});

function populateKategori(){
  const set=new Set();
  allCases.forEach(c=>set.add(c.kategori_aduan));
  set.forEach(k=>{
    const o=document.createElement("option");
    o.value=k;o.textContent=k;
    filterKategori.appendChild(o);
  });
}

function renderTable(){
  caseTable.innerHTML="";
  const fDate=filterDate.value;
  const fKat=filterKategori.value;
  const fStat=filterStatus.value;
  const sCase=searchCase.value.trim();

  allCases.filter(c=>{
    if(fDate && !String(c.created_at).startsWith(fDate)) return false;
    if(fKat && c.kategori_aduan!==fKat) return false;
    if(fStat && c.status_kes!==fStat) return false;
    if(sCase && c.case_id !== sCase) return false;
    return true;
  }).forEach(c=>{
    const cls="status-"+c.status_kes.replace(/\s/g,"");
    caseTable.innerHTML+=`
      <tr>
        <td>${c.case_id}</td>
        <td class="small">${formatMalaysiaDateTime(c.created_at)} ${dayBadge(c.created_at)}</td>
        <td>${c.kategori_aduan}</td>
        <td class="${cls}">${c.status_kes}</td>
        <td>${slaInfo(c.created_at,c.status_kes)}</td>
        <td>
          <button onclick="openUpdate('${c.case_id}')">Update</button>
          <button class="secondary" onclick="openHistory('${c.case_id}')">Sejarah</button>
        </td>
      </tr>`;
  });
}

/* UPDATE */
function openUpdate(id){
  selectedCaseId=id;
  updateCaseId.textContent=id;
  updateModal.style.display="block";
}
function closeUpdate(){ updateModal.style.display="none"; }
function confirmUpdate(){
  fetch(API_POST_URL,{
    method:"POST",
    body:JSON.stringify({
      case_id:selectedCaseId,
      new_status:updateStatus.value,
      actor_name:"dashboard_staff",
      actor_role:"staff",
      note:updateNote.value
    })
  }).then(()=>location.reload());
}

/* HISTORY */
function openHistory(id){
  historyModal.style.display="block";
  historyContent.innerHTML="Loading...";
  fetch(API_GET_URL+"?logs=1&case_id="+id)
  .then(r=>r.json())
  .then(d=>{
    historyContent.innerHTML=d.length?d.map(l=>`
      <div class="log-item">
        <b>${formatMalaysiaDateTime(l.timestamp)}</b><br>
        ${l.actor_name} (${l.actor_role})<br>
        ${l.from_status||"-"} → <b>${l.to_status}</b><br>
        <i>${l.note||"-"}</i>
      </div>`).join(""):"Tiada sejarah";
  });
}
function closeHistory(){ historyModal.style.display="none"; }
</script>

</body>
</html>
