<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Maklumat Aduan Lengkap</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{
  font-family: Arial, sans-serif;
  margin:0;
  padding:18px;
  background:#f4f6f8;
}
h2{
  margin-top:0;
  font-size:18px;
}
.card{
  background:white;
  border-radius:12px;
  padding:16px;
  box-shadow:0 2px 8px rgba(0,0,0,0.08);
  margin-bottom:14px;
  font-size:15px;
  line-height:1.5;
}
a{
  color:#0066ff;
  text-decoration:none;
  font-weight:bold;
}
.action-btn{
  display:inline-flex;
  align-items:center;
  gap:8px;
  margin-top:12px;
  padding:9px 16px;
  background:#0066ff;
  color:white;
  border-radius:8px;
  font-size:14px;
  font-weight:bold;
  text-decoration:none;
}
.action-btn img{
  width:18px;
  height:18px;
}
.back-link{
  display:inline-block;
  margin-top:10px;
  font-size:14px;
}
/* ===== ACTION SHEET ===== */
#actionSheet{
  position:fixed;
  left:0;
  right:0;
  bottom:-100%;
  background:#fff;
  border-radius:18px 18px 0 0;
  box-shadow:0 -4px 12px rgba(0,0,0,0.25);
  padding:18px;
  transition:bottom 0.3s ease;
  z-index:9999;
}
#actionSheet.show{ bottom:0; }
.sheet-title{ font-weight:bold; margin-bottom:12px; }
.sheet-item{
  display:block;
  padding:10px 0;
  border-bottom:1px solid #eee;
  font-size:15px;
}
.sheet-cancel{
  text-align:center;
  margin-top:10px;
  font-weight:bold;
  color:#e60000;
}
@media(max-width:600px){
  body{ padding:14px; }
  h2{ font-size:17px; }
}
</style>
</head>
<body>

<script>
if(localStorage.getItem("operanix_auth") !== "ok"){
  localStorage.setItem("operanix_redirect", window.location.href);
  window.location.href = "login.html";
}
</script>

<h2>Maklumat Aduan Lengkap</h2>
<div id="result">Loading...</div>

<!-- ACTION SHEET -->
<div id="actionSheet">
  <div class="sheet-title">Hubungi Pengadu</div>
  <div id="sheetLinks"></div>
  <div class="sheet-cancel" onclick="closeSheet()">Tutup</div>
</div>

<script>
const apiUrl = "https://script.google.com/macros/s/AKfycby89rBGaqZSh8p8tWPDqg4qeIKbmLDyz1BMpwN8x4LxRdn0ysVs5k4HG52Ara4dzj0BzA/exec"; 
const urlParams = new URLSearchParams(window.location.search);
const caseId = urlParams.get("case_id");

/* ===== MALAYSIA DATE TIME FIXED (SAME AS INDEX) ===== */
function formatMalaysiaDate(timestamp){
  const options={
    timeZone:"Asia/Kuala_Lumpur",
    day:"2-digit",
    month:"2-digit",
    year:"numeric",
    hour:"2-digit",
    minute:"2-digit",
    hour12:true
  }
  const parts=new Intl.DateTimeFormat("en-GB",options)
    .formatToParts(new Date(timestamp))

  const d=parts.find(p=>p.type==="day").value
  const m=parts.find(p=>p.type==="month").value
  const y=parts.find(p=>p.type==="year").value
  const h=parts.find(p=>p.type==="hour").value
  const min=parts.find(p=>p.type==="minute").value
  const ampm=parts.find(p=>p.type==="dayPeriod").value.toUpperCase()

  return `${d}-${m}-${y} . ${h}:${min} ${ampm}`
}

/* ===== ACTION SHEET ===== */
function openSheet(){
  document.getElementById("actionSheet").classList.add("show");
}
function closeSheet(){
  document.getElementById("actionSheet").classList.remove("show");
}

fetch(apiUrl)
.then(res => res.json())
.then(data => {
  let found = data.find(item => item.case_id === caseId);
  if(!found){
    document.getElementById("result").innerHTML = "Kes tidak dijumpai";
    return;
  }

  const lat = found.lat;
  const lng = found.lng;
  const wazeLink = `https://waze.com/ul?ll=${lat},${lng}&navigate=yes`;

  const formattedDate = formatMalaysiaDate(found.created_at);

  let imageHtml = "";
  if(found.image_url){
    imageHtml = `
      <div style="margin-top:10px">
        <img src="${found.image_url}"
             style="width:100%;max-width:420px;border-radius:10px;">
      </div>
    `;
  }

  let phoneStr = found.no_telefon ? String(found.no_telefon) : "";
  let cleanPhone = phoneStr.replace(/[^0-9]/g,'');

  let sheetHTML = "";
  if(cleanPhone){
    sheetHTML += `<a class="sheet-item" href="tel:${cleanPhone}">üìû Phone Call</a>`;
    sheetHTML += `<a class="sheet-item" href="https://wa.me/${cleanPhone}">üí¨ WhatsApp</a>`;
    sheetHTML += `<a class="sheet-item" href="https://wa.me/${cleanPhone}?app_absent=0">üíº WhatsApp Business</a>`;
    sheetHTML += `<a class="sheet-item" href="tg://resolve?domain=${cleanPhone}">üì® Telegram</a>`;
    sheetHTML += `<a class="sheet-item" href="fb-messenger://user/${cleanPhone}">üíô Messenger</a>`;
  }
  document.getElementById("sheetLinks").innerHTML = sheetHTML;

  const aiConfidence = found.AI_confidence || found.ai_confidence || "-";

  document.getElementById("result").innerHTML = `
    <div class="card">
      <b>Case ID:</b> ${found.case_id}<br>
      <b>Tarikh:</b> ${formattedDate}<br><br>

      <b>Nama Pengadu:</b> ${found.nama || "-"}<br>
      <b>No Telefon:</b>
        <a href="javascript:void(0)" onclick="openSheet()">
          ${phoneStr || "-"}
        </a><br>
      <b>No IC:</b> ${found.no_ic || "-"}<br>
      <b>Status SPR:</b> ${found.spr_status || "-"}<br><br>

      <b>Kategori:</b> ${found.kategori_aduan}<br>
      <b>Ringkasan:</b>
      <div style="margin-top:6px;white-space:pre-wrap;">
        ${found.ringkasan_aduan}
      </div>

      <b>Status Kes:</b> ${found.status_kes}<br>
      <b>AI Confidence:</b> ${aiConfidence}<br>

      ${imageHtml}

      <a class="action-btn" href="${wazeLink}" target="_blank">
        <img src="../assets/waze-icon.svg">
        Buka Waze
      </a>
    </div>

    <a class="back-link" href="index.html">‚Üê Kembali ke Peta</a>
  `;
})
.catch(err => {
  document.getElementById("result").innerHTML = "Ralat load data";
  console.error(err);
});
</script>
</body>
</html>
