<!DOCTYPE html>
<html>
<head>
  <title>Operanix | Peta Aduan Petagas</title>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
  <script src="https://unpkg.com/leaflet-pip/leaflet-pip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <style>
    body { margin:0; font-family: Arial, sans-serif; }
    #map { width:100%; height:100vh; }
    .pin-red,.pin-green,.pin-blue,.pin-yellow,.pin-white{
      width:14px;height:14px;border-radius:50%;position:relative;
      animation:pulse 1.8s infinite;
    }
    .pin-red{background:#e60000;}
    .pin-yellow{background:#ffcc00;}
    .pin-blue{background:#0066ff;}
    .pin-green{background:#00aa55;}
    .pin-white{background:#ffffff;border:2px solid #666;}
    @keyframes pulse{
      0%{box-shadow:0 0 0 0 rgba(0,0,0,0.4);}
      70%{box-shadow:0 0 0 10px rgba(0,0,0,0);}
      100%{box-shadow:0 0 0 0 rgba(0,0,0,0);}
    }
    #filterBox{
      position:absolute;top:10px;right:10px;background:white;
      padding:8px;border-radius:6px;box-shadow:0 0 6px rgba(0,0,0,0.2);
      z-index:999;font-size:13px;width:200px;display:none;
    }
    #filterBox input,#filterBox select{
      width:100%;margin-top:4px;margin-bottom:6px;font-size:13px;
      padding:4px;border-radius:4px;border:1px solid #ccc;
    }
    #toggleFilterBtn{
      position:absolute;top:10px;right:10px;background:#0066ff;
      color:white;padding:6px 12px;border-radius:20px;
      font-size:13px;font-weight:bold;cursor:pointer;z-index:1000;
      box-shadow:0 2px 6px rgba(0,0,0,0.3);
    }
    #liveBadge{
      position:absolute;bottom:12px;right:12px;background:#e60000;
      color:white;padding:6px 14px;border-radius:18px;font-weight:bold;
      font-size:13px;animation:blink 1s infinite;z-index:999;
    }
    @keyframes blink{
      0%,100%{opacity:1;}
      50%{opacity:0.4;}
    }
    #legendBox{
      position:absolute;bottom:50px;left:12px;background:white;
      padding:8px 10px;border-radius:8px;box-shadow:0 0 6px rgba(0,0,0,0.25);
      font-size:12px;z-index:999;line-height:1.6;min-width:140px;
    }
    .legend-item{display:flex;align-items:center;gap:6px;margin-bottom:3px;}
    .legend-dot{width:10px;height:10px;border-radius:50%;}
    .legend-blue{background:#0066ff;}
    .legend-yellow{background:#ffcc00;}
    .legend-red{background:#e60000;}
    .legend-green{background:#00aa55;}
    .legend-white{background:#ffffff;border:1px solid #666;}
    #powered{
      position:absolute;bottom:12px;left:12px;background:#111;color:white;
      padding:6px 10px;border-radius:6px;font-size:12px;z-index:999;
    }
  </style>
</head>
<body>

<div id="toggleFilterBtn">Filter</div>

<div id="filterBox">
  <b>Filter</b><br><br>
  Tarikh<br>
  <input type="text" id="dateRange" placeholder="Pilih tarikh"><br>
  Kategori<br>
  <select id="categoryFilter"><option value="">Semua</option></select>
  Kawasan<br>
  <select id="areaFilter">
    <option value="">Semua kawasan</option>
    <option value="inside">Dalam kawasan</option>
    <option value="outside">Luar kawasan</option>
  </select>
</div>

<div id="map"></div>
<div id="liveBadge">● LIVE</div>

<div id="legendBox">
  <b>Status Aduan</b><br>
  <div class="legend-item"><div class="legend-dot legend-blue"></div> Urgency Rendah</div>
  <div class="legend-item"><div class="legend-dot legend-yellow"></div> Urgency Sederhana</div>
  <div class="legend-item"><div class="legend-dot legend-red"></div> Urgency Tinggi</div>
  <div class="legend-item"><div class="legend-dot legend-green"></div> Kes Selesai</div>
  <div class="legend-item"><div class="legend-dot legend-white"></div> Kes Luar Kawasan</div>
</div>

<div id="powered">Powered by Operanix</div>

<script>
const toggleBtn=document.getElementById("toggleFilterBtn")
const filterBox=document.getElementById("filterBox")
toggleBtn.addEventListener("click",()=>{
  filterBox.style.display=(filterBox.style.display==="block")?"none":"block"
})

if(localStorage.getItem("operanix_auth")!=="ok"){
  window.location.href="login.html"
}

const JSON_URL="https://script.google.com/macros/s/AKfycbwfVy4kfxZL55Lf1nTMXmCQXKii7xe07Ywr09CNnSKd60HegA21bnnkH4hMW8dyNbs6BA/exec"
const GEOJSON_URL="N23_petagas.geojson"

const map=L.map('map').setView([3.0738,101.5183],12)
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:18}).addTo(map)

let boundaryLayer,allCases=[],heatLayer
let markerLayer=L.layerGroup().addTo(map)
let selectedStart=null,selectedEnd=null

flatpickr("#dateRange",{
  mode:"range",
  dateFormat:"Y-m-d",
  onChange:function(selectedDates){
    if(selectedDates.length===2){
      selectedStart=selectedDates[0].toISOString().slice(0,10)
      selectedEnd=selectedDates[1].toISOString().slice(0,10)
    }else{
      selectedStart=null;selectedEnd=null
    }
    renderData()
  }
})

async function loadBoundary(){
  const res=await fetch(GEOJSON_URL)
  const geo=await res.json()
  boundaryLayer=L.geoJSON(geo,{style:{color:"#0044cc",weight:3,fillOpacity:0}}).addTo(map)
  map.fitBounds(boundaryLayer.getBounds())
}

/* ===== MALAYSIA DATE TIME FIXED ===== */
function formatMalaysiaDateTime(isoString){
  const options={
    timeZone:"Asia/Kuala_Lumpur",
    day:"2-digit",
    month:"2-digit",
    year:"numeric",
    hour:"2-digit",
    minute:"2-digit",
    hour12:true
  }
  const parts=new Intl.DateTimeFormat("en-GB",options).formatToParts(new Date(isoString))
  const d=parts.find(p=>p.type==="day").value
  const m=parts.find(p=>p.type==="month").value
  const y=parts.find(p=>p.type==="year").value
  const h=parts.find(p=>p.type==="hour").value
  const min=parts.find(p=>p.type==="minute").value
  const ampm=parts.find(p=>p.type==="dayPeriod").value.toUpperCase()
  return { tarikh:`${d}-${m}-${y}`, masa:`${h}:${min} ${ampm}` }
}

async function loadJSON(){
  allCases=[]
  const res=await fetch(JSON_URL)
  const data=await res.json()
  const categorySet=new Set()

  data.forEach(item=>{
    const case_id=item.case_id
    const {tarikh,masa}=formatMalaysiaDateTime(item.created_at)
    const kategori=item.kategori_aduan
    const ringkasan=item.ringkasan_aduan
    const lat=parseFloat(item.lat)
    const lng=parseFloat(item.lng)
    const status=item.status_kes
    const urgency=item.urgency
    const image=item.image_url
    if(isNaN(lat)||isNaN(lng)) return
    categorySet.add(kategori)
    const point=L.latLng(lat,lng)
    const inside=leafletPip.pointInLayer(point,boundaryLayer).length>0
    allCases.push({case_id,tarikh,masa,kategori,ringkasan,lat,lng,inside,status,urgency,image})
  })

  const catSelect=document.getElementById("categoryFilter")
  catSelect.innerHTML='<option value="">Semua</option>'
  categorySet.forEach(k=>{
    const opt=document.createElement("option")
    opt.value=k
    opt.textContent=k
    catSelect.appendChild(opt)
  })
}

function renderData(){
  markerLayer.clearLayers()
  if(heatLayer) map.removeLayer(heatLayer)

  const catVal=document.getElementById("categoryFilter").value
  const areaVal=document.getElementById("areaFilter").value

  const filtered=allCases.filter(c=>{
    let pass=true
    if(selectedStart && c.tarikh.split("-").reverse().join("-")<selectedStart) pass=false
    if(selectedEnd && c.tarikh.split("-").reverse().join("-")>selectedEnd) pass=false
    if(catVal && c.kategori!==catVal) pass=false
    if(areaVal==="inside" && !c.inside) pass=false
    if(areaVal==="outside" && c.inside) pass=false
    return pass
  })

  const heatPoints=filtered.map(c=>[c.lat,c.lng,1])
  heatLayer=L.heatLayer(heatPoints,{radius:40,blur:25,minOpacity:0.4}).addTo(map)

  filtered.forEach(c=>{
    let pinClass="pin-blue"
    if(c.urgency==="sederhana") pinClass="pin-yellow"
    if(c.urgency==="tinggi") pinClass="pin-red"
    if(c.status==="selesai") pinClass="pin-green"
    if(!c.inside) pinClass="pin-white"

    const icon=L.divIcon({
      className:"",
      html:`<div class="${pinClass}"></div>`,
      iconSize:[14,14],
      iconAnchor:[7,7]
    })

    const marker=L.marker([c.lat,c.lng],{icon}).addTo(markerLayer)

    marker.bindPopup(`
      <div style="font-size:13px">
        <div style="color:#555;font-size:12px">
          ${c.tarikh} • ${c.masa}
        </div>
        <b>${c.kategori}</b><br>
        ${c.ringkasan}<br>
        <a href="details.html?case_id=${encodeURIComponent(c.case_id)}" target="_blank">
          Lihat Maklumat Aduan Lengkap →
        </a>
      </div>
    `)
  })
}

document.getElementById("categoryFilter").addEventListener("change",renderData)
document.getElementById("areaFilter").addEventListener("change",renderData)

async function init(){
  await loadBoundary()
  await loadJSON()
  renderData()
  setInterval(async()=>{
    await loadJSON()
    renderData()
  },30000)
}
init()
</script>
</body>
</html>
